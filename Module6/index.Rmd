# Cartographie {#carto}


Ce module porte sur la cartographie et il comporte deux objectifs principaux. Le premier objectif est d'apprendre les principes fondamentaux de la cartographie. Le deuxième objectif est d'apprendre les fonctionnalités de la bibliothèque R `tmap` pour créer divers types de carte avec des données vectorielles et matricielles. 


<br>


###### À la fin de ce module vous saurez: {-}

---

- Décrire les principes fondamentaux à respecter lors de la création d'une carte.
- Identifier les éléments cartographiques indispensables et optionnels.
- Décrire les types de cartes générale et thématique.
- Définir la symbologie utilisée en cartographie. 
- Comprendre le fonctionnement de base de la bibliothèque `tmap`.
- Utiliser les fonctions de `tmap` pour ajouter des éléments cartographiques et ajuster la mise en page d'une carte.
- Utiliser les fonctions de `tmap` pour cartographier des données vectorielles de type points, lignes et polygones.
- Utiliser les fonctions de `tmap` pour cartographier des données matricielles.
- Utiliser les fonctions de `tmap` pour créer des cartes avec symboles proportionnels et choroplèthes.
- Utiliser les fonctions de `tmap` pour créer des cartes à panneaux multiples

---

<div class="boite ico librairie gauche">
###### Vous utiliserez les bibliothèques suivantes: {-}

- `tmap`
- `mapview`
- `tmaptools`

</div>

<div class="boite ico fonctions gauche">
###### Vous apprendrez à utiliser les fonctions suivantes: {-}

- `tm_shape()`
- `tm_fill()`
- `tm_scale_bar()`
- `tm_compass()`
- `tm_grid()`
- `tm_graticules()`
- `tm_credits()`
- `tmap_arrange()`
- `tm_borders()`
- `tm_polygons()`
- `tm_layout()`
- `tm_style()`
- `tm_text()`
- `tm_lines()`
- `tm_markers()`
- `tm_raster()`
- `tm_legend()`
- `tm_symbols()`
- `tm_bubbles()`
- `tm_facets()`


</div>

<div class="boite ico donnees gauche">
###### Vous utiliserez les données suivantes: {-}

Dans la section [leçon](#lecon_carto), vous utiliserez cinq ensembles de données différents. Quatre ensembles sont formés de données vectorielles. Il s'agit de données sur les régions administratives du Québec et la taille de leur population (polygones), des routes du Québec (lignes), des municipalités du Québec (points), et des cas de COVID dans les régions socio-sanitaires du Québec (polygones). L'ensemble de données matricielles correspond à des données d'élévation sur tout le territoire québécois.

Dans la section [exercice](#ex_carto), vous utiliserez des données disponibles dans les bibliothèques `tmap` et `spData`.

</div>



## Leçon {lecon_carto}


### Télécharger les données {#data_mod6}

<div class="boite ico donnees gauche"> 

###### Les données {-} 

<br>

</div>


Importez l'[ensemble des données](https://github.com/sci1031/data/raw/master/Module6_donnees.zip) utilisées dans ce module.
Sauvegardez le dossier compressé (`Module6_donnees.zip`) dans votre répertoire de travail pour ce module, et dézippez-le.
Ce dossier comprend lui-même cinq sous-dossiers que vous devez également dézipper:

- `COVID`
- `Elevation`
- `Population`
- `Routes`
- `Villes`

<br>

Nous utiliserons ces données à partir de la section [6.1.3](#basetmap). Commençons d'abord par une introduction sur les principes de bases de la cartographie.


### Principes de base en cartographie 

### Cartes statiques avec tmap {#basetmap}

Il existe plusieurs bibliothèques R permettant de visualiser des données spatiales. La bibliothèque `mapview`, que nous avons déjà utilisée, en est un exemple. La bibliothèque `ggplot2`, que vous connaissez peut-être, permet de créer des cartes qui peuvent être peaufinées par l'utilisation de fonctions des bibliothèques `sf` et `ggspatial`^[Consulter ce [site](https://r-spatial.org/r/2018/10/25/ggplot2-sf.html) pour en apprendre davantage sur la cartographie avec `ggplot2`]. Dans le cadre de ce cours, nous nous concentrerons sur la bibliothèque `tmap` et l'apprentissage de ses fonctions principales.

Nous avons choisi `tmap` parce que cette bibliothèque est relativement simple à utiliser et que ses fonctions sont intuitives. Le fonctionnement de `tmap` est très similaire à celui de la bibliothèque `ggplot2` qui est fort populaire pour la visualisation de données de toutes sortes. Si vous connaissez déjà `ggplot2`, alors l'apprentissage de `tmap` vous sera familié. Si vous ne connaissez pas `ggplot2`, vous pourriez être amenés à l'utiliser dans le futur, et dans ce cas votre connaissance de `tmap` vous sera utile. 

De façon générale, nous utilisons `tmap` pour cartographier des données spatiales de la façon suivante:

```{r, eval = FALSE}
tm_shape(DonneesSpatiales) + tm_fonction1() + tm_fonction2() + ...
```
<br>

La fonction `tm_shape()` est suivi d'une ou de plusieurs fonctions qui précisent les objets ou les attributs des données à cartographier ainsi que les éléments cartographiques à ajouter et la mise en page souhaitée. 

Télécharger la bibliothèque `tmap`:

```{r, eval = FALSE}
install.packages("tmap")
```


Chargez `tmap` dans votre session de travail R ainsi que les bibliothèques `sf` et `raster` dont nous aurons besoin pour lire et manipuler les données vectorielles et matricielles respectivement:

```{r}
library(tmap)
library(sf)
library(raster)
```

##### Données sur les régions administratives du Québec {-}

Pour débuter notre exploration des fonctions de cartographie offertes avec `tmap` nous utiliserons les données vectorielles sur les limites des régions administratives du Québec ainsi que la taille de leur population. La taille des populations des régions administratives provient de la Banque de données des statistiques officielles sur le Québec (https://bdso.gouv.qc.ca/), et les limites géographiques des régions proviennent du site Données Québec (https://www.donneesquebec.ca/recherche/dataset/decoupages-administratifs).

Utiliser la fonction `st_read()` de la bibliothèque `sf` pour lire le *shapefile* `QC_RegAdm_Pop.shp` contenu dans le dossier `Population`:

```{r}
Q <- st_read("Module6/Module6_donnees/Population/QC_RegAdm_Pop.shp")
```

<br>

Observer la structure et les attributs du *shapefile* `Q`. Celui-ci contient 17 multipolygones, un pour chacune des régions administratives du territoire québécois. De plus, `Q` contient 18 attributs:

- `NUM_REG`: le numéro associé à la région administrative,
- `NOM_REG`: le nom de la région administrative,
- `AREA_REG`: la superficie de la région,
- `ATot_T`: la population totale en 2019 dans la région,
- `ATot_H` / `ATot_F`: le nombre total d'hommes et de femmes dans la région,
- `A0.14_T` / `A0.14_H` /  `A0.14_F`: la pop


#### tm_fill {.unnumbered #fct_tmfill}

La fonction `tm_fill()` permet de remplir de façon homogène l'intérieur des limites d'un polygone. Elle s'applique donc aux données vectorielles de type polygone, et on l'ajoute à la donction `tm_shape()`.

```{r, dev = 'png', fig.height=6}
tm_shape(Q)+ 
  tm_fill()
```
<br>

#### Object tmap {-}

La bibliothèque `tmap` comprend sa propre classe d'objets:

```{r, dev = 'png'}
map_Q <- tm_shape(Q)+ 
             tm_fill()

class(map_Q)
```
<br>
En créant un objet `tmap`, la carte est seulement affichée lorsqu'on appelle l'objet. 
La création d'objet `tmap` est utile car, comme nous le verrons, elle permet de constituer une carte de base à laquelle nous pouvons ajouter des éléments cartographiques.


### Spécificités cartographiques

#### Barre d'échelle et rose des vents {-}

L'ajout d'un barre d'échelle et d'une rose des vents, se fait par l'utilisation des fonctions `tm_scale_bar()` et `tm_compass()` respectivement:

```{r, dev = 'png',fig.height=6}
map_Q +   # la carte du Québec que nous avons créée plus haut
  # ajout d'une barre d'échelle
  tm_scale_bar(breaks = c(0,250,500),
               text.size = 0.8, 
               position=c("right","bottom")) +
  # ajout d'une rose des vents
  tm_compass(type = "arrow", 
             position = c("right", "top"))
```
<br>

où l'argument `break` précise les divisions sur la barre d'échelle, `text.size` la taille du texte sous la barre, et `position` la position de la barre sur la carte (gauche ou droite, haut ou bas).

Plusieurs options d'arguments sont possibles. Utilisez `help(tm_scale_bar)` ou `help(tm_compass)` pour connaître les autres arguments possibles pour ces fonctions. Par exemple,
```{r, dev = 'png',fig.height=6}
map_Q +   
  tm_scale_bar(width = 2, 
               position=c("right","bottom")) +
  tm_compass(type = "4star",
             size = 2, 
             show.labels = 2, 
             position = c("right", "top"))
```
<br>

#### Grille et graticules {-}


La fonction `tm_grid()` ajoute une grille à la carte selon le système de coordonnées projetées des données. Dans le cas présent, le *shapefile* `Q` est exprimé dans le système de coordonnées projetée Conique conforme de Lambert (epsg:32198) qui est métrique. 

La fonction `tm_graticules` ajoute les lignes de longitude et de latitude du système de coordonnées géographiques, c'est-à-dire non-projetées. Dans le cas présent, le *shapefile* `Q` est exprimé dans le système de coordonnées géographiques du Datum North Américain de 1983 (NAD83, espg:4269).

```{r, dev = 'png', fig.height=6}
Q1 <- map_Q + tm_grid()

Q2 <- map_Q + tm_graticules()

tmap_arrange(Q1,Q2)
```
<br> 

Remarquer l'usage de la fonction `tmap_arrange()` pour afficher des cartes côte-à-côte.

Plusieurs options d'arguments existent pour les fonctions `tm_grid()` et `tm_graticules()`. Par exemple, il est possible de préciser le nombre de divisions sur l'axe des *x* (`n.x`) et sur l'axe des *y* (`n.y`)^[Noter que le nombre de divisions créé par `tmap` est approximativement celui demandé car `tmap` crée des divisions uniformément espacées situées sur des coordonnées de valeurs entières.], l'épaisseur du trait (`lwd`), la couleur (`col`) ou encore la taille de l'écriture (`labels.size`).



Donc c'est la meme chose mais graticule donne NSEW ?

```{r, dev = 'png', fig.height=6}
Q1 <- map_Q + tm_grid(labels.size=0.5, 
                      col="yellow", 
                      lwd=3, 
                      n.x = 10, n.y = 4)

Q2 <- map_Q + tm_graticules(labels.col = "darkblue", 
                            alpha = 0.3, 
                            labels.cardinal = FALSE)

tmap_arrange(Q1,Q2)
```
<br>


#### Attribuer les crédits ou la source des données {-}

Il faut utiliser la fonction `tm_credits()` pour ajouter à la carte une mention sur la source des données, ou toute autre information comme l'auteur ou l'autrice de la carte et son organisation d'attache. Par défaut, la mention apparaît dans le coin inférieur droit.

```{r, dev = 'png', fig.height=6}
map_Q + 
  tm_credits("Données récupérées \nsur le site donneesquebec.ca", 
             size = 0.6)
```

<br>

### Cartographier des polygones

Nous avons vu que la fonction `tm_fill()` s'utilise pour représenter des données vectorielles de type polygone. Cette fonction illustre l'intérieur des limites d'un polygone. Or, il existe d'autres fonctions utiles, notamment pour illustrer les frontières des polygones ou chaque polygone individuellement. 

#### Identification des frontières des polygones {-}

La fonction `tm_borders()` permet d'illustrer les frontières des polygones:

```{r, dev = 'png', fig.height=6}
# frontiere des regions admin
tm_shape(Q) +
  tm_borders()
```
<br>


La fonction `tm_borders()` peut s'utiliser conjointement avec la fonction `tm_fill()`:

```{r, dev = 'png', fig.height=6}
# Quebec + frontiere
tm_shape(Q) +
  tm_fill() +
  tm_borders()
```
<br>

Par ailleurs, la fonction `tm_polygons()` est équivalente l'utilisation conjointe de `tm_borders()` et `tm_fill()`:

```{r, dev = 'png', fig.height=6}
# tm_polygons = tm_fill + tm_borders 
tm_shape(Q) +
   tm_polygons()

```

<br>

##### Paramètres esthétiques {-}

Les fonctions `tm_borders()` et `tm_fill()` possèdent plusieurs arguments pour ajuster l'apparence de la carte. Voici des exemples:

```{r, dev = 'png', fig.cap="Cette figure est inspirée de la [figure 9.3](https://geocompr.robinlovelace.net/adv-map.html) du livre Geocomputation with R [@lovelace_geocomputation_2021]."}

# couleur des polygones 
Q1 <- tm_shape(Q) + tm_fill(col="green")

# transparence
Q2 <- tm_shape(Q) + tm_fill(col="green", alpha = 0.4)

# couleur des frontières
Q3 <- tm_shape(Q) + tm_borders(col="green")

# épaisseur du trait
Q4 <- tm_shape(Q) + tm_borders(col="pink", lwd = 4) 

# type de trait
Q5 <- tm_shape(Q) + tm_borders(col="blue", lty = 2) 

# couleur des polygones et des frontières
Q6 <- tm_shape(Q) + tm_fill(col="blue", alpha = 0.3) + 
  tm_borders(col="black")

tmap_arrange(Q1,Q2,Q3,Q4,Q5,Q6)
```

<!--   Images des types de lignes
Rappel types de couleur
-->


#### Identification individuelle des polygones {-}
Polygones de couleurs differentes.
Il sait qu'on réfère à l'attribut désigné.
```{r, dev = 'png'}
tm_shape(Q)+tm_fill(col="NUM_REG", title = "Régions")
```

On veut créer un autre shapefile uniquement pour la région de L'Ouatouais

```{r, dev = 'png'}
Q_Outaouais<-Q[Q$NOM_REG == "Outaouais",]
tm_shape(Q_Outaouais)+tm_fill(col="blue", alpha = 0.4)
```


```{r, dev = 'png'}
Q1<-tm_shape(Q)+tm_borders(col="black")
Q2<-tm_shape(Q_Outaouais)+tm_fill(col="blue", alpha = 0.4)
Q12<-Q1+Q2

Q3<-tm_shape(Q)+tm_fill()
Q4<-tm_shape(Q_Outaouais)+tm_borders(col="blue", lwd = 4)
Q34<-Q3+Q4

tmap_arrange(Q12,Q34)
```

### Mise en page


La fonction `tm_layout` permet d'ajuster la mise en page d'une carte et différents éléments de son esthétique. Pour découvrir l'ensemble des arguments possibles tapez la commande `help(tm_layout)` (ou `?tm_layout`) dans votre console R. Plusieurs des arguments utiles sont présentés ci-dessous.

#### Titre, cadre et couleur du fond {-}

* L'ajout d'un titre (`title`), la taille de ce dernier (`title.size`) et sa position (`title.position`).
* La présence ou l'absence d'un cadre (`frame`) et l'épaisseur du trait de celui-ci (`frame.lw`).
* La taille des marges extérieures au cadre (`outer.margins = c(Haut,Droit,Bas,Gauche)` où `Haut`, `Droit`, `Bas`, `Gauche` sont des chiffres entre 0 (pas de marge) et 1 (marge complète)).
* La couleur du fond de la carte (`bg.color`) et de l'espace à l'extérieure du cadre (`outer.bg.color`).

Voici quelques exemples de mise en page qui utilisent ces arguments.
```{r eval = FALSE, echo = TRUE, dev = 'png'}
map_Q <- tm_shape(Q)+tm_fill()+tm_borders()
map_Q + tm_layout(title = "Carte du Québec", title.size =0.8, title.position = c("right","top"))
map_Q + tm_layout(frame = FALSE)
map_Q + tm_layout(bg.color = "aquamarine", scale = 2)
map_Q + tm_layout(frame.lwd = 2, outer.margins = c(0, 0.2,0, 0.2), outer.bg.color="lavender")
```


```{r eval = TRUE, warning = FALSE, echo = FALSE, dev = 'png'}
Qtitre = map_Q + tm_layout(title = "Carte du Québec", title.size =0.8, title.position = c("right","top"))
Qframe = map_Q + tm_layout(frame = FALSE)
Qbg = map_Q + tm_layout(bg.color = "aquamarine", scale = 2)
Qf = map_Q + tm_layout(aes.color = c(fill = "palegreen", borders = "black"), frame.double.line = TRUE, outer.margins = c(0, 0.2,0, 0.2))
Qmargin = map_Q + tm_layout(frame.lwd = 2, outer.margins = c(0.1, 0.2,0.1, 0.2), outer.bg.color="lavender")

tmap_arrange(Qtitre,Qframe,Qbg,Qmargin, ncol=2, nrow=2, outer.margins = NULL)
```


#### Légende {-}
La fonction `tm_layout()` permet aussi de configurer l'apparence de la légende. Certains des arguments utiles sont:

* La présence, ou non, d'une légende, (`legend.show` - par défaut la légende est affichée).
* L'option de placer la légende à l'extérieur du cadre de la figure (`legend.outside`).
* La position de la légende à l'intérieur (`legend.position`) ou à l'extérieur (`legend.outside.position`) du cadre. Par défaut,la légende est placée dans le coin où il y a le plus d'espace.
* L'option d'un mettre un cadre autour de la légende (`legend.frame`) et de contrôler pour l'épaisseur du trait (`legend.frame.lwd`) et pour la couleur de fond de la légende (`legend.bg.color`)
* La police de caractère (`legend.title.fontfamily`), la taille des caractères (`legend.title.fontface`), et la couleur (`legend.title.color`) du texte et du titre de la légende.

Voici quelques exemples de mise en page de la légende:

```{r eval = FALSE, echo = TRUE, dev = 'png'}

tm_shape(Q) + 
  tm_polygons(col="NOM_REG") + 
  tm_layout(legend.show = FALSE)

Q2 = tm_shape(Q) + 
  tm_fill(col="NOM_REG", title = "Régions administratives") + 
  tm_layout(legend.outside = TRUE)

Q4= tm_shape(Q) +
  tm_polygons(col="NUM_REG", title = "Régions administratives", legend.is.portrait=FALSE) + 
  tm_layout(frame = FALSE, legend.outside = TRUE, 
            legend.outside.position = "bottom", 
            legend.outside.size = 0.15, 
            legend.text.size=0.75)

Q3 = tm_shape(Q) + 
  tm_fill(col="NOM_REG", title = "Régions administratives") + 
  tm_layout(bg.color = "black", frame = FALSE, legend.outside = TRUE, 
            legend.outside.position = "left", 
            legend.title.fontfamily = "serif", 
            legend.title.fontface = 2, 
            legend.title.color = "lightpink", 
            legend.text.color = "white")

```




```{r eval = TRUE, warning = FALSE, echo = FALSE, dev = 'png'}
Q1 = tm_shape(Q)+tm_polygons(col="NOM_REG") + tm_layout(legend.show = FALSE, asp=1)
Q2= tm_shape(Q)+tm_fill(col="NOM_REG", title = "Régions administratives")+tm_layout(legend.outside = TRUE, asp=1)

# Q3= tm_shape(Q)+tm_fill(col="NOM_REG", title = "Régions administratives")+tm_layout(legend.outside = TRUE, legend.outside.position = "bottom", outer.margins = c(0.2, 0,0.2, 0))

Q3= tm_shape(Q)+tm_fill(col="NOM_REG", title = "Régions administratives")+tm_layout(bg.color = "black", frame = FALSE, legend.outside = TRUE, legend.outside.position = "left", legend.title.fontfamily = "serif", legend.title.fontface = 2, legend.title.color = "lightpink", legend.text.color = "white", asp=1)

Q4= tm_shape(Q)+tm_polygons(col="NUM_REG", title = "Régions administratives", legend.is.portrait=FALSE)+tm_layout(frame = FALSE, legend.outside = TRUE, legend.outside.position = "bottom", legend.outside.size = 0.15, legend.text.size=0.75, asp=1)
#Q5 = tm_shape(Q)+tm_fill(col="NUM_REG", title = "Régions administratives", legend.is.portrait=FALSE)+tm_layout(frame = FALSE, legend.outside = TRUE, legend.outside.position = "bottom", legend.outside.size = 0.2, legend.text.size=0.7, legend.frame = TRUE, legend.title.fontfamily = "serif")

tmap_arrange(Q1,Q2,Q4,Q3, ncol=2, nrow=2, widths = c(.30, 0.70),asp=NULL)
#tmap_arrange(Q1,Q2,Q4,Q3, ncol=1, nrow=4,asp=NULL, widths=1)


```

#### Ajustement des couleurs {-}
e plus, la fonction tm_layout permet d'ajuster les couleurs présentes dans la carte:

* L'argument `aes.color` défini la couleur de remplissage des polygones, des frontières, du texte, etc.
* L'argument `saturation` défini le niveau de saturation des couleurs. La valeur par défaut est 1, et la valeur 0 donne une représentation en noir et blanc. Il est possible de donner des valeurs supérieures à 1 pour des couleurs très saturées. Il est aussi possible de données des valeurs négatives. 
* L'argument `sepia.intensity` est un nombre entre 0 et 1 qui défini le niveau de "chaleur" des couleurs. Plus sa valeur est grande, plus les couleurs ont une teinte jaune voir brune. La valeur par défaut est 0.
* L'argument `aes.palette` permet de changer la palette de couleurs utilisées. La librarie tmap utilise les palettes de couleurs de [Color Brewer](https://colorbrewer2.org/). Dans le cas d'attributs catégoriques (comme le nom de régions) la palette utilisée par défaut se nomme `Set3`, mais il est possible de choisir d'autres paletters parmi celles-ci: `Accent`, `Dark2`, `Paired`, `Pastel1`, `Pastel2`, `Set1`, et `Set2`. Nous reviendrons sur le sujet des palettes un peu plus loin dans cete leçon.

Voici quelques exemples de modification des couleurs:

```{r eval = FALSE, echo = TRUE, dev = 'png'}
Q1 = tm_shape(Q)+tm_polygons() + tm_layout(aes.color = c(fill="lightblue",borders="darkgreen"))
Q2 = tm_shape(Q)+tm_polygons(col="NUM_REG") + tm_layout(legend.show = FALSE,
                                                        aes.color = c(borders="white"),
                                                        saturation = 0)
Q3 = tm_shape(Q)+tm_polygons(col="NUM_REG") + tm_layout(legend.show = FALSE,
                                                        sepia.intensity = 0.5)
Q4 = tm_shape(Q)+tm_polygons(col="NUM_REG") + tm_layout(legend.show = FALSE, 
                                                        aes.palette = list(cat = "Accent"))

```



```{r eval = TRUE, warning = FALSE, echo = FALSE, dev = 'png'}

Q1 = tm_shape(Q)+tm_polygons() + tm_layout(aes.color = c(fill="lightblue",borders="darkgreen"))
Q2 = tm_shape(Q)+tm_polygons(col="NUM_REG") + tm_layout(legend.show = FALSE,
                                                        aes.color = c(borders="white"),
                                                        saturation = 0)
Q3 = tm_shape(Q)+tm_polygons(col="NUM_REG") + tm_layout(legend.show = FALSE,
                                                        sepia.intensity = 0.5)
Q4 = tm_shape(Q)+tm_polygons(col="NUM_REG") + tm_layout(legend.show = FALSE, 
                                                        aes.palette = list(cat = "Accent"))

tmap_arrange(Q1,Q2,Q3,Q4, ncol=4, nrow=1)
```

#### Styles prédéfinis {-}
La librarie tmap contient des styles prédéfinis qu'on appelle avec la fonction `tm_style` et qui permettent de ne pas avoir à définir individuellement des arguments de la fonction `tm_layout`.

Voici quelques uns de ces styles prédéfinis. 

```{r eval = FALSE, echo = TRUE, dev = 'png'}
tm_shape(Q)+tm_polygons(col="NUM_REG") + 
                tm_style("classic") +
                tm_layout(legend.show = FALSE) 

tm_shape(Q)+tm_polygons(col="NUM_REG") + 
                tm_style("bw") +
                tm_layout(legend.show = FALSE) 

tm_shape(Q)+tm_polygons(col="NUM_REG") +
                tm_style("cobalt") +
                tm_layout(legend.show = FALSE) 
                                            
tm_shape(Q)+tm_polygons(col="NUM_REG") + 
                tm_style("col_blind") +                             
                tm_layout(legend.show = FALSE) 
                                            
```


```{r eval = TRUE, warning = FALSE, echo = FALSE, dev = 'png'}
Q1 = tm_shape(Q)+tm_polygons(col="NUM_REG") + 
                                  tm_style("classic") +
                                  tm_layout(legend.show = FALSE) 
Q2 = tm_shape(Q)+tm_polygons(col="NUM_REG") + 
                                  tm_style("bw") +
                                  tm_layout(legend.show = FALSE) 
Q3 = tm_shape(Q)+tm_polygons(col="NUM_REG") +
                                  tm_style("cobalt") +
                                  tm_layout(legend.show = FALSE) 
                                            
Q4 = tm_shape(Q)+tm_polygons(col="NUM_REG") + 
                                  tm_style("col_blind") +                             
                                  tm_layout(legend.show = FALSE) 
                                            
tmap_arrange(Q1,Q2,Q3,Q4, ncol=4, nrow=1)

```

<br>

Vous remarquerez que le style `col_blind` utilise une palette de couleur permettant aux personnes daltoniennes de pouvoir différencier les polygones de couleurs différentes.

### Écriture sur une carte

Attention tm_text() ne donne pas les bonnes info ici:https://www.rdocumentation.org/packages/tmap/versions/0.7/topics/tm_text
Il faut aller ici: https://rdrr.io/cran/tmap/man/tm_text.html

```{r, dev = 'png'}
tm_shape(Q)+tm_polygons(col="NUM_REG") + 
                tm_style("col_blind") +                             
                tm_layout(legend.show = FALSE, frame = FALSE)+
#tm_shape(Q)+
  #tm_polygons(col="NUM_REG",palette="", alpha=0.5, legend.show=FALSE) + 
  #tm_layout(frame = FALSE)+
  tm_text("NUM_REG", size = 0.6,fontface="bold")
```

```{r, warning = FALSE, dev = 'png'}
tm_shape(Q)+
  tm_polygons()+
 tm_layout(aes.color = c(fill="black",borders="white"),frame = FALSE, legend.outside = TRUE, legend.text.size = 0.8)+
  tm_text("NUM_REG", col= "NOM_REG", palette = "Paired", size = 0.8, fontface="bold", legend.col.show = TRUE, title.col = "Régions administratives",auto.placement=TRUE, just="right")
```

### Les lignes

#### Données sur le réseau routier du QC {-}
Importer les données
Pas le réseau complet


```{r}
R<-st_read("Module6/Module6_donnees/Routes/QC_routes.shp")
```



On superpose les deux shapefiles. 
Chaque fois qu'on ajouter une tm_shape(Données) les fonctions tm_ qui suivent s'appliquent à ces Données et non aux données antérieures

Probablement plus lent car le fichier est lourd.

```{r, dev = 'png'}
tm_shape(Q)+tm_fill()+
  tm_shape(R)+tm_lines(col="brown") +
  tm_layout(title = "Réseau routier")
```


Ce shapefile comprends en fait trois type de routes.
```{r}
R$ClsRte<-as.factor(R$ClsRte)
levels(R$ClsRte)
```



```{r, dev = 'png'}
pal.col<-c("red","darkgoldenrod4","darkslateblue")
tm_shape(Q)+
  tm_fill()+
  tm_shape(R)+
  tm_lines(col="ClsRte", palette=pal.col, title.col = "Types de route")
```

### Les points

#### Lire le shapefile avec les municiaplites du QC {-}


```{r}
V<-st_read("Module6/Module6_donnees/Villes/QC_coord_municipalites.shp")
```



#### Représentation par des points {-}
```{r, dev = 'png'}
# en dots

Q1<-tm_shape(Q)+tm_fill()+
tm_shape(V)+tm_dots(col="Mncplts", palette="Paired", size = 1)+
tm_layout(frame = FALSE, legend.outside = TRUE, title = "Municipalités", legend.title.color = NA, legend.text.size = 0.8)
Q1
```

#### Représentation par des marqueurs {-}
Toujours bleu

```{r, dev = 'png'}
#en markers

Q3<-tm_shape(Q)+tm_fill()+
  tm_shape(V)+tm_markers(size=0.5)+
  tm_text("Mncplts", size = 0.6, auto.placement=TRUE)+
  tm_layout(inner.margins = c(0.1,0.2,0.1,0.2))

Q3 
```

### Données matricielles

Loader la librairie raster
```{r}
library(raster)
```


#### Importer les données d'élévation du QC  {-}

```{r}
E<-raster("Module6/Module6_donnees/Elevation/QC_Elevation.tif")
```

Expliquer la fonction tm_raster


```{r, dev = 'png'}

tm_shape(E)+tm_raster(title = "Élévation (m)",legend.hist = TRUE)+
  tm_legend(outside = TRUE, hist.width = 4)
```



Nous pouvons changer la palette de couleur (quelle est cette palette par défaut au fait?), et décider du nombre de classes. Il faut expliquer que c'est approximatif.

```{r, dev = 'png', warning = FALSE}
#pal.elevation = colorRampPalette( c("midnightblue","royalblue4","darkolivegreen4","burlywood", "chocolate4"))
pal.elevation = colorRampPalette( c("midnightblue","forestgreen","darkolivegreen4","burlywood", "chocolate4"))
#pal.elevation = colorRampPalette( c("midnightblue","darkolivegreen4","burlywood", "chocolate4"))


#Erose = tm_shape(E)+tm_raster(title = "Classes d'élévation", palette= pal.elevation(4), legend.hist = TRUE,colorNA = "pink" )+
  #tm_legend(outside = TRUE, hist.width = 3)
tm_shape(E)+tm_raster(title = "Élévation", n=10,palette= pal.elevation(10), legend.hist = TRUE, colorNA = "pink" )+
  tm_legend(outside = TRUE, hist.width = 3)
```

Jouer avec la distribution des classes

```{r, dev = 'png', warning = FALSE}
format_carte<-tm_layout(frame = FALSE, legend.position = c(0.67,0.04), legend.title.size = 0.8, legend.format=c(text.align="right"),legend.bg.color = "white", legend.frame = "black")
Efixed<-tm_shape(E)+
  tm_raster(title = "Élévation(m)",palette=pal.elevation(10),  style="fixed", breaks = c(0,100,200,300,400,500,600,700,800,900,1000,1600))+
  format_carte
Equant<-tm_shape(E)+
  tm_raster(title = "Élévation(m)",palette=pal.elevation(10),  style="quantile")+format_carte
tmap_arrange(Efixed,Equant)
```

### Carte avec symboles proportionnels

#### tm_symboles {-}
```{r, warning = FALSE, dev = 'png'}
tm_shape(Q)+
  tm_polygons(col="NUM_REG", legend.show=FALSE) + 
  tm_style("bw") +
  #tm_layout("Population des régions administratives")+
  tm_symbols(col="black", size = "ATot_T", legend.size.show = TRUE, legend.size.is.portrait = TRUE, title.size = "Population")
```
Note: lorsqu'on veut la legende de certains elements seulement, on met FALSE dans celle qu'on veut pas.
Par defaut le symbole est 21, mais on peut mettre autres choses.
http://www.sthda.com/french/wiki/ggplot2-types-de-points-logiciel-r-et-visualisation-de-donnees


##### Mettre deux légendes

```{r, warning = FALSE, dev = 'png'}
tm_shape(Q)+tm_polygons(col="NOM_REG",  palette="Set1", border.col = "darkgrey", title ="Régions administratives") + 
    tm_symbols(size = "ATot_T", border.col = "grey", col="black", scale = 2, legend.size.show = TRUE, legend.size.is.portrait = FALSE, sizes.legend.labels = c("500","1000","1500","2000","2500"), title.size ="Population (en milliers)")+
tm_layout(frame = FALSE, legend.outside = TRUE, legend.stack = "vertical", legend.title.fontface = "bold" ) 

                               
```

#### tm_bubbles {-}
Bubbles: rayon et couleur

FAire le calcul du ratio d'enfant. 
```{r}
Q$Pop_prop_enfant<-Q$A0.14_T/Q$ATot_T
```


```{r, warning = FALSE, dev = 'png'}
tm_shape(Q)+
  tm_polygons(col="NUM_REG", legend.show=FALSE, palette = "Greys") + 
  #tm_layout("Population des régions administratives")+
#tm_bubbles(size ="Pop_prop_enfant", sizes.legend=seq(0.1, 0.27, by=0.02), col= "ATot_T" , style = "quantile", legend.size.show = TRUE, legend.size.is.portrait = TRUE)
  tm_bubbles(size = "ATot_T" , col= "Pop_prop_enfant" , style = "quantile", scale = 2,  border.col = "black", border.lwd
 = .5,legend.size.show = TRUE, legend.size.is.portrait = FALSE, title.size ="Population (en milliers)", title.col = "Proportion d'enfants (0-14 ans)", sizes.legend.labels = c("500","1000","1500","2000","2500"))+
#tm_layout(frame = FALSE, legend.outside = TRUE, legend.outside.position = "bottom", legend.stack = "horizontal") 
  tm_layout(frame = FALSE, legend.outside = TRUE, legend.title.size =1)
```

### Cartes Choroplèthes


Expliquer breaks et n. (comme pour raster)
```{r, warning = FALSE, dev = 'png'}

Q1 = tm_shape(Q)+tm_polygons(col="Pop_prop_enfant")
#Q2 = tm_shape(Q)+tm_polygons(col="Pop_prop_enfant", breaks = seq(0.1, 0.3, by=0.02))
Q2 = tm_shape(Q)+tm_polygons(col="Pop_prop_enfant", breaks = c(0.1, 0.14, 0.15, 0.16, 0.18, 0.3))
Q3 = tm_shape(Q)+tm_polygons(col="Pop_prop_enfant", n=2)

tmap_arrange(Q1,Q2,Q3)


```


#### Données COVID {-}

Lire les données: cas cumulés de COVID en date du 18 janvier 2021 par région socio-sanitaire.


```{r}
Q_covid <-st_read("Module6/Module6_donnees/COVID/QC_Covid_210118.shp")
```




Comme pour la proportion d'enfants, on veut la densité de cas: la proportion de cas par rapport à la population totale d'une région socio-sanitaire
```{r}
Q_covid$prop_cas<-(Q_covid$Cs_cmls)/(Q_covid$ATot_T)
```


Comparaison nombre vs proportion
```{r, warning = FALSE, dev = 'png'}

Q_nombre<-tm_shape(Q_covid)+tm_polygons(col="Cs_cmls", title = "Nombre de cas")

Q_prop<-tm_shape(Q_covid)+tm_polygons(col="prop_cas", title = "Proportion de cas")

tmap_arrange(Q_nombre,Q_prop)
```


Expliquer le sens de chaque style.
Voir: https://bookdown.org/nicohahn/making_maps_with_r5/docs/tmap.html#static-maps-with-tmap
```{r, warning = FALSE, dev = 'png'}
format_carte <-tm_layout(legend.text.size = 0.55)

Q_quantile<-tm_shape(Q_covid)+tm_polygons(col="prop_cas", style = "quantile", title = "Quantile")+format_carte
Q_jenks<-tm_shape(Q_covid)+tm_polygons(col="prop_cas", style = "jenks", title = "Jenks")+format_carte
Q_pretty<-tm_shape(Q_covid) + tm_polygons(col="prop_cas", style = "pretty", title = "Pretty")+format_carte

tmap_arrange(Q_quantile,Q_jenks,Q_pretty)
```

C'est souvent en regardant la distribution des données qu'on peut déterminer la meilleure classification pour représenter nos données
EXEMPLE DE MELANIE ou alors faire ça au début.


### Cartes à panneau multiple
Qu'est-ce qu'un facet?

Représenter chaque region individuellement
```{r, warning = FALSE, dev = 'png'}
tm_shape(Q_covid)+tm_polygons(col="prop_cas", style = "quantile", legend.is.portrait = FALSE)+
  tm_facets(by="NOM_REG", nrow =4,  scale.factor = 5)+
  tm_layout(panel.label.height=2, panel.label.size = 0.9, legend.show = FALSE)

```

Il est possible de jouer avec les couleurs, le font, le cadre des panels en utilisant les argument panel.label.size, fontface, bg.color de la fonction tm_layout
https://rdrr.io/cran/tmap/man/tm_layout.html.


### Cartes avec encadré

Prenons une section de la carte d'élévation autour de la région de l'Outaouais
```{r}
# Boite basee sur les limites de Q_Outaouais
rectangle<-extent(-719204,-479847,182366,454979)

# Utiliser ce rectangle pour sélectionner une région à l'intérieur de la carte d'élévation
G<-crop(E,rectangle)

# Transformer les contours de ce rectangle en polygone grâce à la bibliothèque tmaptools
library(tmaptools)
Gpoly<-bb_poly(G)

```

```{r, warning = FALSE, dev = 'png'}
format_carte<-tm_layout(frame = FALSE, legend.position = c(0.74,0.32), legend.title.size = 0.8, legend.bg.color = "white", legend.frame = "black")

# Définir la carte principale
Map_raster<-tm_shape(G)+tm_raster(title = "Élévation (m)", palette= pal.elevation(5))+format_carte+
tm_scale_bar(position=c("left","bottom"), text.size = 0.8) 

# Définir l'encadré où le rectangle est superposé à la carte générale du Québec
Map_inset<-tm_shape(Q)+tm_polygons()+
  tm_shape(Gpoly)+tm_borders(lw=2, col="red")

# Utilisation de la fonction viewport de la bibliothèque grid
library(grid)
Map_raster
print(Map_inset, vp=viewport(0.67,0.17,width=0.3, height=0.3))

```


<!--   ### Cartes interactives avec tmap -->

## Exercices

